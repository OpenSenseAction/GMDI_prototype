{% extends "base.html" %}

{% block title %}Real-Time Data - GMDI Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<style>
    #map {
        height: 500px;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #mapClickPlot {
        height: 180px;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        background-color: #f9fafb;
        display: none;
        overflow: auto;
    }

    #mapClickPlot.active {
        display: block;
    }

    .map-plot-info {
        padding: 1rem;
        background-color: #f0f7ff;
        border-left: 4px solid #0066cc;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        display: none;
    }

    .map-plot-info.active {
        display: block;
    }

    .cml-selector {
        margin-bottom: 1.5rem;
    }

    .cml-selector label {
        font-weight: 600;
        color: #0066cc;
        margin-bottom: 0.75rem;
        display: block;
        font-size: 0.9rem;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }

    .chart-container {
        background-color: transparent;
        padding: 0;
        border-radius: 0.5rem;
    }

    .selector-group {
        display: flex;
        gap: 0.5rem;
    }

    .selector-group .form-select {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <section class="mb-5 pb-4 border-bottom">
        <h1 class="mb-2">
            <i class="fas fa-globe"></i> Real-Time Data Visualization
        </h1>
        <p class="text-secondary mb-0">Live CML network map and signal measurements</p>
    </section>

    <!-- CML Network Map -->
    <section class="mb-5">
        <h2 class="mb-3">
            <i class="fas fa-map"></i> Network Coverage Map
        </h2>

        <div class="map-plot-info" id="mapPlotInfo">
            <i class="fas fa-info-circle"></i>
            <strong id="selectedCmlInfo">CML selected</strong> â€” Displaying time series data below
        </div>

        {% if map_html %}
        <div id="map">
            {{ map_html | safe }}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Unable to load map.</strong> Please ensure the database is running.
        </div>
        {% endif %}

        <!-- Interactive plot from map click -->
        <div id="mapClickPlot"></div>
    </section>

    <!-- Time Series Data -->
    <section class="mb-5">
        <h2 class="mb-3">
            <i class="fas fa-chart-line"></i> Signal Measurements
        </h2>

        <!-- CML Selector -->
        <div class="cml-selector">
            <label for="cmlSelect">Select CML Link</label>
            <div class="selector-group">
                <select id="cmlSelect" class="form-select">
                    {% for cml in cmls %}
                    <option value="{{ cml }}" {% if cml==selected_cml %}selected{% endif %}>
                        CML {{ cml }}
                    </option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" id="loadButton" type="button">
                    <i class="fas fa-sync-alt"></i> Load
                </button>
            </div>
        </div>

        <!-- Time Series Chart -->
        <div class="chart-container">
            <div class="card">
                <div class="card-body">
                    {% if plot_html %}
                    <div id="timeSeriesChart">
                        {{ plot_html | safe }}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        <strong>No data available</strong> for the selected CML
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- Data Info -->
    <section class="mb-5">
        <h2 class="mb-3">
            <i class="fas fa-info-circle"></i> About This Data
        </h2>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h5 style="color: #0066cc; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-signal"></i> Received Signal Level (RSL)
                        </h5>
                        <p class="text-secondary mb-0" style="font-size: 0.9rem;">
                            The strength of the radio signal at the receiver. Changes in RSL correlate with atmospheric
                            phenomena, particularly rainfall.
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h5 style="color: #0066cc; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-clock"></i> Update Frequency
                        </h5>
                        <p class="text-secondary mb-0" style="font-size: 0.9rem;">
                            Data is updated regularly as new measurements arrive from the CML network. Select a link
                            above to view recent measurements.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    // Store CML list from template
    const cmlList = {{ cmls | tojson }};
    let cmlMetadata = {};

    console.log('Page initialized with CML list:', cmlList);

    // Load CML metadata on page load
    async function loadCMLMetadata() {
        try {
            const response = await fetch('/api/cml-metadata');
            const data = await response.json();
            data.cmls.forEach(cml => {
                cmlMetadata[cml.id] = cml;
            });
            console.log('CML Metadata loaded:', cmlMetadata);
            // Setup map interactivity after metadata is loaded
            setTimeout(setupMapInteractivity, 1000);
        } catch (error) {
            console.error('Error loading CML metadata:', error);
            setTimeout(setupMapInteractivity, 1000);
        }
    }

    // Setup interactive map - attach click handlers to SVG paths
    function setupMapInteractivity() {
        const mapElement = document.querySelector('#map');

        if (!mapElement) {
            console.warn('Map element not found');
            return;
        }

        // Find the Leaflet container and SVG
        const svgContainer = mapElement.querySelector('svg');

        if (!svgContainer) {
            console.warn('SVG container not found, retrying...');
            setTimeout(setupMapInteractivity, 500);
            return;
        }

        // Get all polyline paths (blue lines)
        const paths = svgContainer.querySelectorAll('path');
        console.log('Found', paths.length, 'paths in map');

        let cmlIndex = 0;
        let pathsAttached = 0;

        paths.forEach((path, index) => {
            // Skip paths that are not polylines (like grid lines, etc)
            const stroke = path.getAttribute('stroke');
            const fill = path.getAttribute('fill');

            // Check if this is a blue polyline (stroke is blue, no fill)
            if ((stroke === 'blue' || stroke === '#0000ff') && !fill) {
                // Get the CML ID from our list
                if (cmlIndex < cmlList.length) {
                    const cmlId = cmlList[cmlIndex];
                    cmlIndex++;

                    // Store reference
                    path.dataset.cmlId = cmlId;
                    path.style.cursor = 'pointer';

                    // Add click event
                    path.addEventListener('click', function (e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('Clicked CML:', this.dataset.cmlId);
                        loadMapClickPlot(this.dataset.cmlId);
                    });

                    // Add hover effects
                    path.addEventListener('mouseover', function () {
                        this.style.strokeWidth = '4px';
                        this.style.opacity = '1';
                    });

                    path.addEventListener('mouseout', function () {
                        this.style.strokeWidth = '2.5px';
                        this.style.opacity = '0.8';
                    });

                    pathsAttached++;
                }
            }
        });

        console.log('Attached click handlers to', pathsAttached, 'paths');
    }

    // Load and display plot from map click
    async function loadMapClickPlot(cmlId) {
        const plotContainer = document.getElementById('mapClickPlot');
        const infoBox = document.getElementById('mapPlotInfo');
        const selectedCmlInfo = document.getElementById('selectedCmlInfo');

        if (!plotContainer) {
            console.error('Plot container not found');
            return;
        }

        console.log('Loading plot for CML:', cmlId);

        // Show loading state
        plotContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading data for CML ' + cmlId + '...</div>';
        plotContainer.classList.add('active');
        infoBox.classList.add('active');
        selectedCmlInfo.textContent = 'CML ' + cmlId + ' selected';

        try {
            const response = await fetch(`/api/timeseries/${cmlId}?hours=24`);
            const data = await response.json();

            console.log('Response received for CML', cmlId, ':', data);

            if (data.html) {
                plotContainer.innerHTML = data.html;
            } else {
                plotContainer.innerHTML = '<div class="alert alert-warning" style="margin: 1rem;"><i class="fas fa-exclamation-triangle"></i> No data available for this CML</div>';
            }
        } catch (error) {
            console.error('Error loading plot:', error);
            plotContainer.innerHTML = '<div class="alert alert-danger" style="margin: 1rem;"><i class="fas fa-exclamation-circle"></i> Error loading data. Please try again.</div>';
        }
    }

    // Handle manual CML selection from dropdown
    if (document.getElementById('loadButton')) {
        document.getElementById('loadButton').addEventListener('click', function () {
            const cmlId = document.getElementById('cmlSelect').value;
            const loadButton = document.getElementById('loadButton');

            console.log('Manual load for CML:', cmlId);

            // Show loading state
            loadButton.disabled = true;
            loadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            // Fetch new data
            fetch(`/api/timeseries/${cmlId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('timeSeriesChart').innerHTML = data.html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('timeSeriesChart').innerHTML =
                        '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error loading data. Please try again.</div>';
                })
                .finally(() => {
                    // Reset button state
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-sync-alt"></i> Load';
                });
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Page loaded, initializing...');
        loadCMLMetadata();
    });
</script>
{% endblock %}