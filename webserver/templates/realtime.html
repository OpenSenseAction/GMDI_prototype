{% extends "base.html" %}

{% block title %}Real-Time Data - GMDI Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<style>
    /* Full-screen layout below navbar */
    html,
    body {
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    main {
        padding: 0 !important;
        margin: 0 !important;
        min-height: calc(100vh - 60px);
        position: relative;
    }

    main .container {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        min-height: calc(100vh - 60px);
        width: 100%;
    }

    footer {
        display: none !important;
    }

    .realtime-wrapper {
        width: 100%;
        min-height: calc(100vh - 60px);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .map-container {
        flex: 1;
        min-height: 0;
        position: relative;
        width: 100%;
    }

    #cml-map {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
    }

    .chart-container {
        height: 500px;
        flex-shrink: 0;
        position: relative;
        width: 100%;
    }

    .grafana-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: none;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="realtime-wrapper">
    <div class="map-container">
        <div id="cml-map"></div>
    </div>
    <div class="chart-container">
        <iframe class="grafana-container" id="grafana-panel"
            src="http://localhost:3000/d/cml-realtime/cml-real-time-data?orgId=1&var-cml_id=10001&refresh=10s&theme=light&from=now-7d&to=now&viewPanel=2&kiosk"
            allowfullscreen></iframe>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    let map;
    let cmlLayers = {};
    let cmlStats = {};
    let selectedCmlId = '10001';
    let currentColoringOption = 'completeness';

    // Color functions for each option
    const colorFunctions = {
        completeness: function (stat) {
            if (!stat) return '#0066cc';
            const completeness = stat.completeness_percent || 0;
            if (completeness >= 90) return '#22c55e'; // green
            if (completeness >= 70) return '#eab308'; // yellow
            if (completeness >= 50) return '#f97316'; // orange
            return '#ef4444'; // red
        },
        last_rsl: function (stat) {
            if (!stat) return '#0066cc';
            const rsl = stat.last_rsl;
            if (rsl === null) return '#808080'; // gray for missing data
            if (rsl >= -40) return '#22c55e'; // green
            if (rsl >= -45) return '#eab308'; // yellow
            if (rsl >= -50) return '#f97316'; // orange
            return '#ef4444'; // red
        },
        std_dev: function (stat) {
            if (!stat) return '#0066cc';
            const stddev = stat.stddev_last_60min;
            if (stddev === null) return '#808080'; // gray for missing data
            if (stddev <= 1) return '#22c55e'; // green (very stable)
            if (stddev <= 2) return '#eab308'; // yellow (moderate)
            if (stddev <= 3) return '#f97316'; // orange (variable)
            return '#ef4444'; // red (very unstable)
        }
    };

    function getColor(stat, option) {
        if (colorFunctions[option]) {
            return colorFunctions[option](stat);
        }
        return '#0066cc';
    }

    // Initialize map
    function initializeMap() {
        console.log('Initializing map...');
        try {
            map = L.map('cml-map').setView([57.705, 11.97], 11);
            // Use Carto Positron - clean, minimal light basemap
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19,
                subdomains: 'abcd'
            }).addTo(map);
            console.log('Map created');

            // Add custom control for CML coloring
            var ColorControl = L.Control.extend({
                options: {
                    position: 'topright'
                },
                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                    container.style.backgroundColor = 'white';
                    container.style.padding = '10px';
                    container.style.fontSize = '14px';

                    var label = L.DomUtil.create('div', '', container);
                    label.innerHTML = '<strong>Color by:</strong>';
                    label.style.marginBottom = '5px';

                    var select = L.DomUtil.create('select', '', container);
                    select.id = 'coloringOption';
                    select.innerHTML = `
                        <option value="completeness" selected>Data Completeness</option>
                        <option value="last_rsl">Last RSL Value</option>
                        <option value="std_dev">RSL Std Dev (60min)</option>
                    `;

                    // Prevent map interactions when using the select
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);

                    return container;
                }
            });
            map.addControl(new ColorControl());

            // Fetch stats first
            console.log('Fetching CML stats...');
            try {
                fetch('/api/cml-stats')
                    .then(function (response) {
                        console.log('Stats response received:', response.status);
                        var el = document.getElementById('debugStats');
                        if (el) el.textContent = 'stats=status:' + response.status;
                        return response.json();
                    })
                    .then(function (stats) {
                        console.log('Received stats for ' + stats.length + ' CMLs');
                        stats.forEach(function (stat) {
                            cmlStats[stat.cml_id] = stat;
                        });
                        var el2 = document.getElementById('debugStats');
                        if (el2) el2.textContent = 'stats=ok:' + stats.length;
                        loadCmlData();
                    })
                    .catch(function (error) {
                        console.error('Error loading stats:', error);
                        var errEl = document.getElementById('debugError');
                        if (errEl) errEl.textContent = 'lastError=stats:' + (error && error.message ? error.message : String(error));
                        var el3 = document.getElementById('debugStats');
                        if (el3) el3.textContent = 'stats=error';
                        loadCmlData(); // Try loading without stats
                    });
            } catch (e) {
                console.error('Exception when fetching stats:', e);
                var errEl = document.getElementById('debugError');
                if (errEl) errEl.textContent = 'lastError=stats-ex:' + String(e);
                loadCmlData();
            }
        } catch (e) {
            console.error('Error in initializeMap:', e);
        }

        // Add event listener for coloring option change
        var coloringSelect = document.getElementById('coloringOption');
        if (coloringSelect) {
            coloringSelect.addEventListener('change', function (e) {
                console.log('Coloring option changed to: ' + e.target.value);
                currentColoringOption = e.target.value;
                updateMapColors();
            });
        }
    }

    // Load and draw CML data
    function loadCmlData() {
        console.log('Loading CML map data...');
        try {
            fetch('/api/cml-map')
                .then(function (response) {
                    console.log('Map response received:', response.status);
                    var el = document.getElementById('debugMap');
                    if (el) el.textContent = 'mapData=status:' + response.status;
                    return response.json();
                })
                .then(function (cmls) {
                    console.log('Drawing ' + cmls.length + ' CMLs');
                    var el2 = document.getElementById('debugMap');
                    if (el2) el2.textContent = 'mapData=ok:' + cmls.length;
                    cmls.forEach(function (cml) {
                        drawCmlLine(cml);
                    });
                    console.log('Done drawing');
                })
                .catch(function (error) {
                    console.error('Error loading map data:', error);
                    var errEl = document.getElementById('debugError');
                    if (errEl) errEl.textContent = 'lastError=map:' + (error && error.message ? error.message : String(error));
                    var el3 = document.getElementById('debugMap');
                    if (el3) el3.textContent = 'mapData=error';
                });
        } catch (e) {
            console.error('Exception when loading map data:', e);
            var errEl = document.getElementById('debugError');
            if (errEl) errEl.textContent = 'lastError=map-ex:' + String(e);
        }
    }

    // Draw CML line on map with initial color
    function drawCmlLine(cml) {
        var cmlId = cml.cml_id;
        var stats = cmlStats[cmlId];
        var color = getColor(stats, currentColoringOption);

        var latlngs = [
            [cml.site_0.lat, cml.site_0.lon],
            [cml.site_1.lat, cml.site_1.lon]
        ];

        var polyline = L.polyline(latlngs, {
            color: color,
            weight: 2,
            opacity: 0.7
        });
        polyline.addTo(map);

        // Store the stats for updating
        polyline._cmlId = cmlId;
        polyline._stats = stats;

        // Create popup with stats
        var popupText = '<strong>CML ' + cmlId + '</strong><br>';
        if (stats) {
            popupText += 'Completeness: ' + stats.completeness_percent + '%<br>';
            popupText += 'Valid records: ' + stats.valid_records + '/' + stats.total_records + '<br>';
            if (stats.last_rsl !== null) {
                popupText += 'Last RSL: ' + stats.last_rsl + ' dBm<br>';
            }
            if (stats.stddev_last_60min !== null) {
                popupText += 'Std Dev (60min): ' + stats.stddev_last_60min + '<br>';
            }
        }
        polyline.bindPopup(popupText);

        // Add click handler
        polyline.on('click', function () {
            selectCml(cmlId);
        });

        // Add hover effects
        polyline.on('mouseover', function () {
            this.setStyle({ weight: 4, opacity: 1 });
        });
        polyline.on('mouseout', function () {
            this.setStyle({ weight: 2, opacity: 0.7 });
        });

        cmlLayers[cmlId] = polyline;
    }

    // Update all map line colors based on current coloring option
    function updateMapColors() {
        console.log('Updating colors for option: ' + currentColoringOption);
        for (var cmlId in cmlLayers) {
            if (cmlLayers.hasOwnProperty(cmlId)) {
                var polyline = cmlLayers[cmlId];
                var stats = polyline._stats;
                var color = getColor(stats, currentColoringOption);
                polyline.setStyle({ color: color });
            }
        }
    }

    // Select CML and update interface
    function selectCml(cmlId) {
        console.log('Selected CML: ' + cmlId);
        selectedCmlId = cmlId;

        // Update Grafana iframe URL with new CML ID
        var grafanaPanel = document.getElementById('grafana-panel');
        var base = 'http://localhost:3000/d/cml-realtime/cml-real-time-data';
        var params = [
            'orgId=1',
            'var-cml_id=' + encodeURIComponent(cmlId),
            'refresh=10s',
            'theme=light',
            'from=now-7d',
            'to=now',
            'viewPanel=2',
            'kiosk'
        ];
        grafanaPanel.src = base + '?' + params.join('&');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        initializeMap();
    });
</script>
{% endblock %}