{% extends "base.html" %}

{% block title %}Data Uploads - GMDI Platform{% endblock %}

{% block extra_css %}
<style>
    .admin-notice {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 0.375rem;
    }

    .upload-option {
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 2rem;
        margin-bottom: 1.5rem;
        transition: all 0.2s;
    }

    .upload-option:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
    }

    .upload-option.disabled {
        opacity: 0.6;
        pointer-events: none;
        background-color: #f8f9fa;
    }

    .upload-option h3 {
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }

    .upload-option .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .status-badge.active {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.not-implemented {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-badge.in-progress {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .dropzone {
        border: 2px dashed #0d6efd;
        border-radius: 0.375rem;
        padding: 2rem;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s;
    }

    .dropzone:hover {
        background-color: #e7f3ff;
        border-color: #0b5ed7;
    }

    .dropzone.dragover {
        background-color: #e7f3ff;
        border-color: #0b5ed7;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1 class="mb-4">
            <i class="fas fa-cloud-upload-alt"></i> Data Uploads
        </h1>

        <!-- Admin Notice -->
        <div class="admin-notice">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Administrator Notice:</strong> The options below must be configured by an administrator. Regular
            users can use the available upload methods once they are properly configured.
        </div>

        <!-- Upload Options -->
        <div class="upload-options">
            <!-- Option 1: Automatic File Transmission -->
            <div class="upload-option disabled">
                <div class="status-badge not-implemented">
                    <i class="fas fa-clock"></i> Not Implemented
                </div>
                <h3>
                    <i class="fas fa-cogs"></i> Automatic File Transmission
                </h3>
                <p class="text-muted mb-2">
                    Automatically receive and process data files from configured sources. This feature allows continuous
                    data ingestion from external systems.
                </p>
                <p class="mb-0">
                    <small><strong>Configuration:</strong> Currently being developed. Administrators can configure
                        automatic data sources, schedules, and validation rules.</small>
                </p>
            </div>

            <!-- Option 2: Drag and Drop -->
            <div class="upload-option">
                <div class="status-badge in-progress">
                    <i class="fas fa-hammer"></i> Work in Progress
                </div>
                <h3>
                    <i class="fas fa-hand-paper"></i> Drag and Drop Upload
                </h3>
                <p class="text-muted mb-3">
                    Easily upload data files by dragging and dropping them into the area below.
                </p>

                <!-- Drag and Drop Zone (will be implemented) -->
                <div class="dropzone" id="dropzone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3" style="display: block;"></i>
                    <p class="mb-0">
                        <strong>Drag and drop your files here</strong><br>
                        <small class="text-muted">or click to select files</small>
                    </p>
                </div>

                <!-- File List (will be populated) -->
                <div id="fileList" class="mt-3" style="display: none;">
                    <h5>Uploaded Files</h5>
                    <ul class="list-group" id="files">
                    </ul>
                </div>

                <!-- Upload Progress (will be shown) -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                        </div>
                    </div>
                    <small id="progressText" class="text-muted mt-2" style="display: block;"></small>
                </div>
            </div>
        </div>

        <!-- File Browser Section -->
        <section class="mt-5">
            <h2 class="h4 mb-3">
                <i class="fas fa-folder-open"></i> File Browser
            </h2>

            <!-- Note about background process -->
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle"></i>
                <strong>Note:</strong> Files in the "Incoming" folder will be automatically staged for processing by a
                background process. Once staged, they will appear in the "Staged for Processing" folder.
            </div>

            <!-- Incoming Files -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-inbox"></i> Incoming Files
                    </h5>
                </div>
                <div class="card-body">
                    <div id="incomingFilesList">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Staged Files -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-hourglass-start"></i> Staged for Processing
                    </h5>
                </div>
                <div class="card-body">
                    <div id="stagedFilesList">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Information Section -->
        <section class="mt-5">
            <h2 class="h4 mb-3">
                <i class="fas fa-info-circle"></i> Upload Guidelines
            </h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Supported File Formats</h5>
                    <p class="mb-3">
                        Currently supported file formats for upload:
                    </p>
                    <ul>
                        <li><strong>NetCDF (.nc)</strong> - Network Common Data Format</li>
                        <li><strong>CSV (.csv)</strong> - Comma-separated values</li>
                        <li><strong>HDF5 (.h5, .hdf5)</strong> - Hierarchical Data Format</li>
                    </ul>

                    <h5 class="card-title mt-4">File Size Limits</h5>
                    <p class="mb-0">
                        Maximum file size per upload: <strong>500 MB</strong>
                    </p>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const dropzone = document.getElementById('dropzone');
    const fileList = document.getElementById('fileList');
    const filesContainer = document.getElementById('files');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Highlight dropzone on drag over
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropzone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropzone.classList.remove('dragover');
    }

    // Handle drop
    dropzone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // Handle click to select files
    dropzone.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = '.nc,.csv,.h5,.hdf5';
        input.onchange = (e) => handleFiles(e.target.files);
        input.click();
    });

    async function handleFiles(files) {
        for (let file of files) {
            await uploadFile(file);
        }
        loadFiles();
    }

    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            uploadProgress.style.display = 'block';
            progressText.textContent = `Uploading ${file.name}...`;
            progressBar.style.width = '0%';

            const xhr = new XMLHttpRequest();

            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    progressText.textContent = `✓ ${file.name} uploaded successfully (${response.size_mb} MB)`;
                    progressBar.style.width = '100%';
                    progressBar.classList.add('bg-success');
                } else {
                    const response = JSON.parse(xhr.responseText);
                    progressText.textContent = `✗ Error: ${response.error}`;
                    progressBar.style.width = '100%';
                    progressBar.classList.remove('bg-success');
                    progressBar.classList.add('bg-danger');
                }
            });

            xhr.addEventListener('error', () => {
                progressText.textContent = `✗ Error uploading ${file.name}`;
                progressBar.style.width = '100%';
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-danger');
            });

            xhr.open('POST', '/api/upload');
            xhr.send(formData);

        } catch (error) {
            console.error('Error uploading file:', error);
            progressText.textContent = `✗ Error uploading ${file.name}`;
        }
    }

    // Load and display files from server
    async function loadFiles() {
        try {
            const response = await fetch('/api/files');
            const data = await response.json();

            // Populate incoming files
            const incomingFilesList = document.getElementById('incomingFilesList');
            if (data.incoming_files && data.incoming_files.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group';

                data.incoming_files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <strong>${file.filename}</strong><br>
                            <small class="text-muted">${file.size_mb} MB • Uploaded: ${file.upload_time}</small>
                        </div>
                        <span class="badge bg-warning text-dark">Incoming</span>
                    `;
                    ul.appendChild(li);
                });

                incomingFilesList.innerHTML = '';
                incomingFilesList.appendChild(ul);
            } else {
                incomingFilesList.innerHTML = '<p class="text-muted">No incoming files</p>';
            }

            // Populate staged files
            const stagedFilesList = document.getElementById('stagedFilesList');
            if (data.staged_files && data.staged_files.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group';

                data.staged_files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <strong>${file.filename}</strong><br>
                            <small class="text-muted">${file.size_mb} MB • Staged: ${file.upload_time}</small>
                        </div>
                        <span class="badge bg-info">Staged</span>
                    `;
                    ul.appendChild(li);
                });

                stagedFilesList.innerHTML = '';
                stagedFilesList.appendChild(ul);
            } else {
                stagedFilesList.innerHTML = '<p class="text-muted">No staged files</p>';
            }

        } catch (error) {
            console.error('Error loading files:', error);
            document.getElementById('incomingFilesList').innerHTML = '<p class="text-danger">Error loading files</p>';
            document.getElementById('stagedFilesList').innerHTML = '<p class="text-danger">Error loading files</p>';
        }
    }

    // Load files on page load and refresh every 5 seconds
    document.addEventListener('DOMContentLoaded', loadFiles);
    setInterval(loadFiles, 5000);
</script>
{% endblock %}