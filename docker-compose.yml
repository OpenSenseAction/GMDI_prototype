services:
  mno_simulator:
    build: ./mno_data_source_simulator
    depends_on:
      - sftp_receiver
    volumes:
      - ./parser/example_data:/app/example_data:ro
      - mno_data_to_upload:/app/data_to_upload
      - mno_data_uploaded:/app/data_uploaded
      - ./ssh_keys:/app/ssh_keys:ro
    environment:
      - SFTP_HOST=sftp_receiver
      - SFTP_PORT=22
      - SFTP_USERNAME=cml_user
      - SFTP_REMOTE_PATH=/uploads
      - SFTP_USE_SSH_KEY=true
      - SFTP_PRIVATE_KEY_PATH=/app/ssh_keys/id_rsa
      - SFTP_KNOWN_HOSTS_PATH=/app/ssh_keys/known_hosts

  parser:
    build: ./parser
    ports:
      - "5004:5004"
    depends_on:
      - database
    environment:
      - DATABASE_URL=postgresql://myuser:mypassword@database:5432/mydatabase
      - PARSER_INCOMING_DIR=/app/data/incoming
      - PARSER_ARCHIVED_DIR=/app/data/archived
      - PARSER_QUARANTINE_DIR=/app/data/quarantine
      - PARSER_ENABLED=true
      - PROCESS_EXISTING_ON_STARTUP=true
      - LOG_LEVEL=INFO
    volumes:
      - sftp_uploads:/app/data/incoming
      - parser_archived:/app/data/archived
      - parser_quarantine:/app/data/quarantine

  database:
    build: ./database
    ports:
      - "5432:5432"

  processor:
    build: ./processor
    ports:
      - "5002:5002"
    depends_on:
      - database
    environment:
      - DATABASE_URL=postgresql://myuser:mypassword@database:5432/mydatabase

  webserver:
    build: ./webserver
    ports:
      - "5000:5000"
    depends_on:
      - database
      - sftp_receiver
    environment:
      - DATABASE_URL=postgresql://myuser:mypassword@database:5432/mydatabase
      - STORAGE_BACKEND=local  # Options: local, s3, minio
      - STORAGE_BASE_PATH=/app/data
    volumes:
      - sftp_uploads:/app/data/incoming:ro  # Read-only access to SFTP uploads
      - webserver_data_staged:/app/data/staged
      - webserver_data_archived:/app/data/archived

  sftp_receiver:
    image: atmoz/sftp:latest
    ports:
      - "2222:22"
    volumes:
      - sftp_uploads:/home/cml_user/uploads
      - ./ssh_keys/sftp_host_ed25519_key:/etc/ssh/ssh_host_ed25519_key:ro
      - ./ssh_keys/sftp_host_rsa_key:/etc/ssh/ssh_host_rsa_key:ro
      - ./ssh_keys/authorized_keys:/home/cml_user/.ssh/keys/authorized_keys:ro
      - ./sftp_receiver/entrypoint.sh:/custom-entrypoint.sh:ro
    entrypoint: ["/custom-entrypoint.sh"]
    command: cml_user::1001:1001:uploads

  # Optional: MinIO for S3-compatible object storage (uncomment to use)
  # minio:
  #   image: minio/minio:latest
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   volumes:
  #     - minio_data:/data
  #   command: server /data --console-address ":9001"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    depends_on:
      - database
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_SECURITY_ALLOW_EMBEDDING=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning

  # Integration test runner (run with: docker compose run --rm integration_tests)
  integration_tests:
    build:
      context: .
      dockerfile: tests/Dockerfile
    depends_on:
      - sftp_receiver
      - webserver
      - mno_simulator
    environment:
      - SFTP_HOST=sftp_receiver
      - SFTP_PORT=22
    volumes:
      - ./tests:/workspace/tests:ro
      - ./ssh_keys:/workspace/ssh_keys:ro
      - ./pyproject.toml:/workspace/pyproject.toml:ro
    network_mode: "service:sftp_receiver"
    profiles:
      - testing

volumes:
  sftp_uploads:
  webserver_data_staged:
  webserver_data_archived:
  grafana_data:
  mno_data_to_upload:
  mno_data_uploaded:
  parser_archived:
  parser_quarantine:
  # minio_data:  # Uncomment if using MinIO